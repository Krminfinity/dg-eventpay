# DG EventPay 要件定義（PRD v0）

更新日: 2025-08-30
作成者: プロダクト/開発合同（ドラフト）

## 1. ビジョン / ゴール
- ビジョン: 「社会の飲みニケーション文化を守る」。幹事の集金負担を極小化し、安心・迅速・気まずさゼロの集金体験を提供。
- 成功指標（例）
  - 参加者支払い完了率 ≥ 95%（イベント前日まで）
  - 幹事の回収所要時間 80%削減
  - 支払い～可視化までのレイテンシ p95 ≤ 3秒
  - 決済失敗率 ≤ 1.0%、チャージバック率 ≤ 0.2%

## 2. 対象ユーザー / ペルソナ
- 幹事（個人/企業）: 学生サークル幹事、部署飲み会の主催者、人事/総務、NPO担当者
- 参加者: イベント参加者（社内/社外）
- 内部運用者: カスタマーサポート、審査/リスク、運用管理（アドミン）

## 3. スコープ（MVP）/ 非スコープ
- MVPに含む
  - イベント作成（タイトル/日時候補/会費/募集期限/キャンセルポリシー）
  - 日程調整（候補提示と投票）、最終日程確定
  - 参加登録（氏名/連絡先/参加可否/備考）
  - 事前決済リンク配布（URL共有）
  - マルチ決済（PSP経由: MVPはKOMOJU Hosted。まずはクレカ/PayPay/コンビニ払いを順次有効化）
  - 支払い状況のリアルタイム可視化（幹事/参加者）
  - 返金（全額/部分）とキャンセル処理（ポリシー準拠）
  - 自動精算（幹事口座への振込）
  - 通知（メール + アプリ内、MVPではSMS/LINEは任意）
  - 幹事の本人確認/KYC（振込のため）
  - 運用管理画面（簡易）/ Webhook受信 / 監査ログ
- 非スコープ（将来）
  - 食べログ連携の本格レコメンド/予約連携（PoCは可）
  - 参加人数/消費量の高度なAI予測（PoC）
  - ネイティブアプリ（まずはレスポンシブWeb/PWA）
  - LINE公式アカウント統合、企業SSO、組織/部門ツリー管理の高度化

## 4. ユースケース / ユーザーストーリー
- 幹事として、イベントページを3分で作成し、URLを共有できる
- 参加者として、アカウント不要/最小入力でオンライン決済を完了できる
- 幹事として、誰が支払ったかを一覧で把握し、未払い者にワンクリックでリマインドできる
- 幹事として、キャンセル申請が来たらポリシーに基づき自動/半自動で返金できる
- 幹事として、イベント終了後に自動で振込明細を受け取れる
- CS/運用として、決済・返金・振込のトラブルをトレースし解決できる

## 5. 機能要件（MVP）
### 5.1 認証・権限
- 参加者: アカウント不要の支払いフロー（メール確認のみ可）。
- 幹事: メール+パスワード/SSO(Google, Microsoft)任意。メールリンク認証。
- 権限: Organizer, Co-host, Participant, Admin。イベント単位の共同管理を許可。

### 5.2 イベント管理
- 作成: タイトル、説明、主催者、会費（税込/税別）、上限人数、締切、キャンセルポリシー、タグ。
- 日程調整: 複数候補の投票、締切後に確定、確定通知。
- 参加登録: 名前/メール/社名/備考、プライバシー同意、利用規約同意。
- 公開設定: 公開/非公開、リンク知ってる人のみ、参加承認制（任意）。

### 5.3 決済
- 支払手段（PSP: KOMOJU）: クレカ（主要ブランド）、PayPay、コンビニ払い（審査に応じ順次）。
- フロー: 支払いリンク→ゲートウェイの安全な画面/トークン化→支払い結果Webhook→状態更新。
- 事前決済原則（当日現地徴収の代替）/ オプションで当日決済リンク。
- 返金: 全額/部分、期間/手数料条件に応じた自動計算、原路返金優先。
- 手数料/消費税: プラットフォーム利用料 + PG手数料のモデル定義（設定可能）。

### 5.4 精算（振込）
- 幹事KYC/KYB（個人/法人）：本人確認、銀行口座登録、反社チェック。
- 振込サイクル: T+X日（例: 週次）/ コンビニ入金は入金確認後。
- 明細: イベント別収支、手数料内訳、CSV/PDF出力。

### 5.5 可視化 / 通知
- ダッシュボード: 支払済/未払/返金中、参加者数、金額合計、ステータスフィルタ。
- 通知: 支払い完了、未払いリマインド、日程確定、返金完了、振込完了（メール/アプリ内）。

### 5.6 管理・運用
- 管理画面: ユーザー/イベント/支払い/返金/振込の参照・再送・手動調整。
- Webhook: 決済成功/失敗、返金、チャージバック、入金、振込の受信と再試行。
- 監査ログ: 重要操作（返金/振込設定/権限変更）を記録。

## 6. 非機能要件
- セキュリティ/コンプライアンス
  - カード情報は保持しない（トークン化/ホスト型画面）。PCI DSSはSAQ A/またはA-EP相当。
  - 個人情報: 目的外利用禁止、暗号化（At-Rest/Transit）、最小権限、監査ログ。
  - 日本法対応: 資金決済法、特商法、個人情報保護法、電気通信事業法、景表法。
- 可用性/SLO: 稼働率 ≥ 99.9%、主要API p95 ≤ 300ms、Webhook処理再試行（指数バックオフ）。
- パフォーマンス: 同時決済ピーク 200 RPS（拡張可能）。リマインド一斉送信分散。
- スケーラビリティ: 水平スケール、非同期キュー（決済/通知）。
- 監視/可観測性: メトリクス、分散トレース、構成監査、アラートRunbook。
- アクセシビリティ/多言語: 日本語優先、将来英語。WCAG 2.1 AA相当。
- サポート: ヘルプセンター、問い合わせフォーム、SLA定義（企業プラン）。

## 7. 外部連携
- PSP: MVPはKOMOJU Hosted（Hosted/返金/Webhook対応）。将来、VeriTrans4Gへ移行可能な抽象化を維持。
- 食べログ: 店舗/コース検索API（パートナー契約次第）、MVPはリンクアウトor手入力。
- Probabilistic Computing: 参加人数/消費量予測API（社内基盤）。PoC段階はバッチ推論。

## 8. データモデル（高レベル）
- User, OrganizerProfile, Organization, Role
- Event, DateOption, RSVP, Participant
- PaymentIntent, Payment, Refund, Chargeback
- PayoutBatch, Payout, BankAccount
- PricingPlan, Fee, Invoice/Receipt
- Notification, WebhookEvent, AuditLog
- Venue, Recommendation (将来)

主な関係例:
- Event 1—N RSVP / PaymentIntent
- PaymentIntent 1—0..1 Payment / 0..N Refund
- OrganizerProfile 1—N Event / 1—N Payout

## 9. API（概略・REST）
- POST /events, GET /events/:id, PATCH /events/:id
- POST /events/:id/date-options, POST /events/:id/confirm-date
- POST /events/:id/invite, POST /events/:id/rsvp
- POST /events/:id/payment-intents
- GET /payments/:id, POST /payments/:id/refund
- GET /events/:id/summary
- POST /webhooks/psp
- GET /payouts, GET /payouts/:id

## 10. 料金/課金ポリシー（案）
- プラットフォーム手数料: 決済額のx% + y円（税別）
- PG手数料: 決済種別ごと実費
- 返金手数料: 条件に応じプラットフォーム手数料の返戻可否を定義

## 11. リスク/対策
- 未払い/ドタキャン: 事前決済/キャンセルポリシー/リマインド自動化
- チャージバック: 3Dセキュア推奨/不正スコアリング/証跡保全
- コンビニ払いの不一致/期限切れ: 有効期限表示/期限管理と自動キャンセル
- 法令/審査: KYC/KYB標準化、利用規約/特商法表記の整備

## 12. 計測/分析
- ファネル（イベント作成→共有→RSVP→支払い→完了）
- 決済成功率、返金率、リマインド効果、振込遅延
- 予測モデルのMAE/MAPE（将来）

## 13. ロードマップ（案）
- Phase 0: 技術検証（KOMOJU接続、Webhook、トークン化、振込シミュレーション）
- Phase 1 (MVP): イベント作成/RSVP/事前決済/可視化/返金/振込/基本運用
- Phase 2: 食べログPoC、AI予測PoC、LINE通知、企業管理機能
- Phase 3: 予約連携本格化、ダイナミックプライシング、ネイティブアプリ
- 将来: VeriTrans4Gへの移行検討（多決済/企業向け要件に応じて）

## 14. オープンクエスチョン
- 食べログAPIの正式な利用可否/範囲？
- 法人口座/個人口座の対応範囲と振込スキーム（収納代行/資金移動業スキーム）？
- 料金モデル（B2B/B2C/非営利割引）？
- 返金ポリシーの既定（イベント前日/当日など閾値）？
- LINE/SMS通知の初期対応有無？

## 15. MVP決定事項（お金周り）
- 事前決済100%（参加確定=決済完了）。未払いは締切で自動キャンセル。
- 成立条件（任意）: min_participants または min_total_amount を設定可能。締切未達は自動キャンセル+全額返金（プラットフォーム手数料も返戻、PG手数料は当社負担/MVP限定）。
- 決済手段: クレジットカード（Hosted）限定。3DセキュアはPG標準を有効化。オーソリ/キャプチャは即時売上。
- 返金/キャンセル: 締切前は全額、締切後は原則不可（例外は手動）。返金は原路に自動実行。
- リマインド: 未払い者にT-3日/ T-1日で自動メール通知。
- 振込: 週次（金曜締め→翌水曜手動振込）。最低振込額1万円、未満は繰越。明細はCSV。
- 幹事ガイド: 締切後に予約確定できる会場選定を推奨（キャンセル無料期間内）。

---
このPRDはドラフトです。議論に応じて更新します。
